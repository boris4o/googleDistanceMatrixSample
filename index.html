<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" /> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>Distance Matrix Sample</title> 
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script type="text/javascript"> 
 
  var origins = new Array();
 
  var destinations = new Array();
 
  var query = {
    travelMode: google.maps.TravelMode.DRIVING,
    unitSystem: google.maps.UnitSystem.METRIC
  };
 
  var dms;
  var originsInterval = 0;
  var originsLimit;
  
  var QUERY_LIMIT = 100;
  
  function updateMatrix() {
    updateQuery();
    dms.getDistanceMatrix(query, function(response, status) {
        if (status == "OK") {
          populateTable(response.rows);
        }else{
            alert("There was a problem with the request.  The reported error is '"+status+"'");
        }
      }
    );
  }
 
  function createTable() {
    var table = document.getElementById('matrix');
    var tr = addRow(table);
    addElement(tr);
    for (var j = 0; j < destinations.length; j++) {
      var td = addElement(tr);
      td.setAttribute("class", "destination");
      td.appendChild(document.createTextNode(destinations[j]));
    }
 
    for (var i = 0; i < origins.length; i++) {
      var tr = addRow(table);
      var td = addElement(tr);
      td.setAttribute("class", "origin");
      td.appendChild(document.createTextNode(origins[i]));
      for (var j = 0; j < destinations.length; j++) {
        var td = addElement(tr, 'element-' + i + '-' + j);
      }
    }
  }
  
  /*
   * Retrieves origins and destinations from textareas and
   * determines how to build the entire matrix within query limitations.
   */
  function getInputs(){
    var originsString = document.getElementById('origins').value;
    var destinationsString = document.getElementById('destinations').value;
    
    origins = originsString.split("|");
    destinations = destinationsString.split("|");
    
    query.destinations = destinations;
    originsLimit = Math.floor(QUERY_LIMIT/destinations.length);
    if(originsLimit > 25){
        originsLimit = 25;
    }
  }
  
  /*
   * Updates the query based on the known sizes of origins and destinations.
   */
  function updateQuery(){
    if(origins.length * destinations.length < QUERY_LIMIT && originsLimit < 25){
        query.origins = origins;
        originsInterval=1;
    }else{
        query.origins = origins.slice(originsLimit*originsInterval,originsLimit*(originsInterval+1));
        originsInterval++;
    } 
  } 
  
  /*
   * Initializes the matrix data and pulls the first set of near 100 results.
   */
  function matrixInit(){
    dms = new google.maps.DistanceMatrixService();
    getInputs();
    createTable();
    updateMatrix();
    disableInitButton();
  } 
  
  function populateTable(rows) {
    var elementX;
    for (var i = 0; i < rows.length; i++) {
      for (var j = 0; j < rows[i].elements.length; j++) {
        elementX = originsLimit*(originsInterval-1) + i;
        if(rows[i].elements[j].status != "ZERO_RESULTS"){
            var distance = rows[i].elements[j].distance.text;
            var duration = rows[i].elements[j].duration.text;
            var td = document.getElementById('element-' + elementX + '-' + j);
            td.innerHTML = distance + "<br/>" + duration;
        }else{
            var td = document.getElementById('element-' + elementX + '-' + j);
            td.innerHTML = "No results available," + "<br/>" + "Check your location.";                        
        }
      }
    }
    
    if(origins.length <= elementX+1){
        disableUpdateButton(false);
    }else{
        disableUpdateButton(true);
    }
  }
 
  function updateUnits() {
    switch (document.getElementById("units").value) {
      case "km":
        query.unitSystem = google.maps.UnitSystem.METRIC;
        break;
      case "mi":
        query.unitSystem = google.maps.UnitSystem.IMPERIAL;
        break;
    }
    updateMatrix();
  }
 
  function addRow(table) {
    var tr = document.createElement('tr');
    table.appendChild(tr);
    return tr;
  }
 
  function addElement(tr, id) {
    var td = document.createElement('td');
    if (id) {
      td.setAttribute('id', id);
    }
    tr.appendChild(td);
    return td;
  }
  
  function disableInitButton(){
    document.getElementById('initButton').disabled=true;
  }
  
  function enableInitButton(){
    document.getElementById('initButton').disabled=false;
  }
  
  function disableUpdateButton(withTimer){
    document.getElementById('updateButton').disabled=true;
    if(withTimer){
        setTimeout("enableUpdateButton()",10000);
        document.getElementById('updateButton').value="Wait 10 seconds...";
    }else{
        enableClearButton();
    }
  }
  
  function enableUpdateButton(){
    document.getElementById('updateButton').disabled=false;
    document.getElementById('updateButton').value="Add more values";
  }
  
  function disableClearButton(){
    document.getElementById('clearButton').disabled=true;
  }
  
  function enableClearButton(){
    document.getElementById('clearButton').disabled=false;
  }
  
  function clearTable(){
    var table = document.getElementById('matrix');
    var rowCount = table.rows.length;
 
    for(var i=0; i<rowCount; i++) {
        table.deleteRow(0);    
    }
    
    originsInterval = 0;
    originsLimit = null;
       
    disableClearButton();
    enableInitButton();
  }
</script> 
<style> 
body {
  font-family: sans-serif;
  font-size:.8em;
}
 
#container {
  width:100%;
  padding:15px;
}
 
#matrix {
  font-size: 10px;
  border-collapse: collapse;
}
 
#controls {
  
}
 
.origin,.destination {
  font-weight: bold;
  text-align: center;
  background-color: #e0ffe0;
}
 
td {
  border: 1px solid grey;
  width: 100px;
  cursor: default;
  background-color: #ffffff;
}
  
</style> 
</head> 
<body> 
<div id="container"> 
  <div id="controls"> 
    Enter pipe delimited origins and destinations.  Optionally, modify the output units to specify imperial or metric results (default is metric); due to the results limitations, changes to the unit system will only affect future requests - it will not affect data already present in the table.  You must limit your destinations to 25 in this utility.  Acceptable values for origins or destinations are:<br />
    <ul>
        <li>Text that Google identifies as a single location</li>
        <li>Latitude and longitude values separated by a comma</li>
    </ul>
    Examples that work:
    <ul>
        <li>36,-75|34.222,-100.444</li>
        <li>Lewiston, ME|Midland,MI</li>
    </ul>
    Examples that may cause problems:
    <ul>
        <li>36 -75|34.222,-300.444</li>
        <li>Lewiston|Midland</li>
    </ul>
    <br />
    Unit System:<br />
    <form id="queryInputs">
        <select id="units" onChange="updateUnits()"> 
          <option value="km"  selected="selected">Metric</option> 
          <option value="mi">Imperial</option> 
        </select><br />
        Origins:<br />
        <textarea id="origins" rows="5" cols="50">adams,wa|asotin,wa</textarea><br />
        Destinations:<br />
        <textarea id="destinations" rows="5" cols="50">48.191405, -124.075584|48.149733, -123.147240</textarea><br />
        <input type="button" id="initButton" onClick="matrixInit()" value="Get matrix"></button>
        <input type="button" id="updateButton" onClick="updateMatrix()" disabled="true" value="Add more values"></button>
        <input type="button" id="clearButton" onClick="clearTable()" disabled="true" value="Clear matrix"></button>
    </form>
  </div> 
  <table id="matrix"></table> 
</div> 
</body> 
</html> 
